{# /Users/fledoux/Sites/informatique.it.com/templates/page/dashboard.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}
	{{ 'Dashboard.Welcome'|trans|raw }}
{% endblock %}

{% block body %}
	<div
		class="container-xxl py-4">

		{# Titre + actions rapides #}
		<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-5">
			<h1 class="h3 mb-3 mb-sm-0">
				<i class="fa-light fa-gauge"></i>
				{{ 'Dashboard.Welcome'|trans|raw }}
			</h1>
			<div class="d-flex flex-column flex-sm-row flex-wrap gap-2 ms-md-auto">
				{% if is_granted('ROLE_USER') %}
					<a href="{{ path('app_ticket_new') }}" class="btn btn-orange w-100 w-sm-auto">
						{{ 'Btn.NewTicket'|trans|default('Nouveau ticket')|raw }}
					</a>
				{% endif %}
				{% if is_granted('ROLE_ADMIN') %}
					<a href="{{ path('app_contact_new') }}" class="btn btn-outline-secondary w-100 w-sm-auto">
						{{ 'Btn.NewContact'|trans|default('Nouveau contact')|raw }}
					</a>
				{% endif %}
				{% if is_granted('ROLE_SUPER_ADMIN') %}
					<a href="{{ path('app_company_new') }}" class="btn btn-outline-secondary w-100 w-sm-auto">
						{{ 'Btn.NewCompany'|trans|default('Nouvelle société')|raw }}
					</a>
				{% endif %}
			</div>
		</div>

		{# KPIs #}
		<div class="row g-3 mb-5">
			<div class="col-12 col-md-4 col-xl-2">
				<div class="card shadow-sm h-100">
					<div class="card-body d-flex align-items-center gap-3">
						<i class="fa-light fa-message-question fs-3 text-orange"></i>
						<div>
							<div class="text-muted small">{{ 'Dashboard.KPI.Tickets'|trans|default('Tickets') }}</div>
							<div class="fs-4 fw-semibold">{{ ticketsCount }}</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-12 col-md-4 col-xl-2">
				<div class="card shadow-sm h-100 {{ openTicketsCount > 0 ? 'bg-danger text-white' : '' }}">
					<div class="card-body d-flex align-items-center gap-3">
						<i class="fa-light fa-clipboard-list-check fs-3 {{ openTicketsCount > 0 ? 'text-white' : 'text-orange' }}"></i>
						<div>
							<div class="small">{{ 'Dashboard.KPI.Open'|trans|default('Ouverts') }}</div>
							<div class="fs-4 fw-semibold">{{ openTicketsCount }}</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-12 col-md-4 col-xl-2">
				<div class="card shadow-sm h-100 {{ waitingCount > 0 ? 'bg-warning' : '' }}">
					<div class="card-body d-flex align-items-center gap-3">
						<i class="fa-light fa-clock fs-3 {{ waitingCount > 0 ? '' : 'text-orange' }}"></i>
						<div>
							<div class="text-muted small">{{ 'Dashboard.KPI.Waiting'|trans|default('En attente') }}</div>
							<div class="fs-4 fw-semibold">{{ waitingCount }}</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-12 col-md-4 col-xl-2">
				<div class="card shadow-sm h-100 {{ overdueCount > 0 ? 'bg-danger text-white' : '' }}">
					<div class="card-body d-flex align-items-center gap-3">
						<i class="fa-light fa-triangle-exclamation fs-3 {{ overdueCount > 0 ? 'text-white' : 'text-orange' }}"></i>
						<div>
							<div class="small">{{ 'Dashboard.KPI.Overdue'|trans|default('En retard') }}</div>
							<div class="fs-4 fw-semibold">{{ overdueCount }}</div>
						</div>
					</div>
				</div>
			</div>
			{% if is_granted('ROLE_ADMIN') %}
				<div class="col-12 col-md-4 col-xl-2">
					<div class="card shadow-sm h-100">
						<div class="card-body d-flex align-items-center gap-3">
							<i class="fa-light fa-address-book fs-3 text-orange"></i>
							<div>
								<div class="text-muted small">{{ 'Dashboard.KPI.Contacts'|trans|default('Contacts') }}</div>
								<div class="fs-4 fw-semibold">{{ contactsCount }}</div>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
			{% if is_granted('ROLE_SUPER_ADMIN') %}
				<div class="col-12 col-md-4 col-xl-2">
					<div class="card shadow-sm h-100">
						<div class="card-body d-flex align-items-center gap-3">
							<i class="fa-light fa-buildings fs-3 text-orange"></i>
							<div>
								<div class="text-muted small">{{ 'Dashboard.KPI.Companies'|trans|default('Sociétés') }}</div>
								<div class="fs-4 fw-semibold">{{ companiesCount }}</div>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
		</div>

		{# Derniers tickets #}
		<div class="card shadow-sm border-4">
			<div class="card-header d-flex align-items-center justify-content-between">
				<h2 class="h6 mb-0">
					<i class="fa-light fa-clock-rotate-left me-2"></i>
					{{ 'Dashboard.RecentTickets'|trans|default('Derniers tickets') }}
				</h2>
				<a href="{{ path('app_ticket_index') }}" class="btn btn-sm btn-link text-decoration-none">
					{{ 'Btn.ViewAll'|trans|default('Tout voir')|raw }}
					→
				</a>
			</div>
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-sm table-hover align-middle mb-0">
						<thead class="table-light">
							<tr>
								<th class="text-nowrap text-center">{{ 'Ticket.Id'|trans|default('N°') }}</th>
								<th>{{ 'Ticket.Ticket_status'|trans|default('Statut') }}</th>
								<th>{{ 'Ticket.Priority'|trans|default('Priorité') }}</th>
								<th>{{ 'Ticket.Subject'|trans|default('Objet') }}</th>
								<th>{{ 'Ticket.Company'|trans|default('Société') }}</th>
								<th>{{ 'Ticket.AssignedTo'|trans|default('Assigné à') }}</th>
								<th>{{ 'Ticket.DueAt'|trans|default('Échéance') }}</th>
								<th class="text-end">{{ 'Global.Actions'|trans|default('Actions') }}</th>
							</tr>
						</thead>
						<tbody>
							{% for t in recentTickets %}
								<tr>
									<td class="text-muted text-center">{{ t.id }}</td>
									<td>
										{% set st = t.ticketStatus ? t.ticketStatus.value : null %}
										<span class="badge bg-{{ ('Ticket.statusClass.' ~ st)|trans }}">
											{{ st ? ('Ticket.status.' ~ st)|trans : '—' }}
										</span>
									</td>
									<td>
										<span class="badge bg-light text-dark">
											{{ t.priority ? ('Ticket.priority.' ~ t.priority)|trans : '—' }}
										</span>
									</td>
									<td class="text-truncate" style="max-width:320px">{{ t.subject }}</td>
									<td>{{ t.companyId ? t.companyId.name : '—' }}</td>
									<td>{{ t.assignedToId ? t.assignedToId.email : '—' }}</td>
									<td>{{ t.dueAt ? t.dueAt|date('d/m/Y H:i') : '—' }}</td>
									<td class="text-end">
										<a href="{{ path('app_ticket_show', {'id': t.id}) }}" class="btn btn-sm btn-outline-primary">
											<i class="fa-regular fa-eye"></i>
										</a>
										<a href="{{ path('app_ticket_edit', {'id': t.id}) }}" class="btn btn-sm btn-outline-secondary">
											<i class="fa-regular fa-pen-to-square"></i>
										</a>
									</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="8" class="text-center text-muted py-4">Aucun ticket pour le moment.</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

	</div>

{% endblock %}
